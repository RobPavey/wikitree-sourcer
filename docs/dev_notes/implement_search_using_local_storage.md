# Implement search using local storage

When a site does not support search using a URL query Sourcer uses a system where it:
- saves the search data in local storage
- opens the site's search page in a new tab/window (or it can reuse a tab)
- the site's content script checks if it is on a search page and if there is recent search data in local storage
- if so, it uses the search data to fill out the search form

Example sites that use this system are `freecen`, `freereg`, `nswbdm`, `ncbdm`, `psuk`, `scotp`, `vicbdm`, `wiewaswie`, `wikitree`.

The files generated by the `create_new_site` script assume that the site can be searched via URL query. This doc describes the changes needed to make the search work using local storage.

The `freereg` is a good simple example to look at for this. `vicbdm` is a more complex example that allows reuse of a tab already open on that site.

# The `<site>_build_search_data.mjs` file

If you answered the question in the create_new_site script to say that the site does not support search by URL query then the `create_new_site` script will have created the file `core/<site>_build_search_data.mjs`. This is what you should use.

If not you will have to make some changes:
* the `create_new_site` script will have created the file `core/<site>_build_search_url.mjs` and `<site>_url_builder.mjs`.
* Delete the `<site>_uri_builder.mjs` file as it is not needed if not using a URL query.
* Rename `core/<site>_build_search_url.mjs` to `core/<site>_build_search_data.mjs`. See an example like `freereg` to see what this file should contain. You can either delete the whole contents and copy the contents from another site or edit the functions that are there in which case the import of `<site>_uri_builder.mjs` should be removed.
It should export a function named `buildSearchData` which returns an object. The properties of this object are site specific but usually it has a property named `fieldData`.

# The `<site>_popup_search.mjs` file

The default file (if you did not answer the question correctly) will have an async function called `<site>Search` which loads the module `../core/<site>_build_search_url.mjs` and then passes this to the common helper function `doSearch`.

To use local storage change `<site>Search`to call a local function which you will write called `<site>DoSearch`. This function will load the `<site>_build_search_data.mjs` module and use it to build the search data.

The function should then check permissions to check that the extension has permission to open the site's search page (or ask the user to grant them).

There are two different patterns you can use here:
1. The simpler system used by `freecen`, `freereg`, `psuk`, `scotp`, `wiewaswie` and `wikitree`.
2. The common `doBackgroundSearchWithSearchData` function which is more powerful but a bit more complex. This is used by `nswbdm`, `nzbdm` and `vicbdm`. It is also used by the `gro` smart search.

The second pattern allows for already open tabs on the site to be used for the search. This relies on the site content script registering open tabs and the content script gets complicated if the open page is not the search page. Most sites that use this have a search option so the user can choose whether to use an open tab or open a new one. This pattern is good to use for sites where it takes a long time to open a new page.

# The `<site>_content.js` file

If you answered the question in the create_new_site script to say that the site does support search by URL query but have now realized that it does not...

The site's content script needs to be changed to check for the search data when the site's search page is loaded.

The complexity of this varies from site to site. For sites using the more complex `doBackgroundSearchWithSearchData` pattern the content script will be more complex.

For most sites this is not needed. A simple site to look at is `freereg`. In `freereg_content.js` you will see the functions `checkForSearchThenInit`, `checkForPendingSearch` and `getPendingSearch`. Follow this same pattern in your content script.

For the more complex pattern you will need to implement functions like `registerTabWithBackground`, `unregisterTabWithBackground`, `registerTabThenCallDoPendingSearch`.


